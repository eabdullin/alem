name: Build Desktop Distributables

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read

jobs:
  build:
    name: Build and package (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Windows
            os: windows-latest
            dist_args: --win
            artifact_name: qurt-windows-dist
          - name: macOS
            os: macos-latest
            dist_args: --mac
            artifact_name: qurt-macos-dist

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # macOS notarization via App Store Connect API key (recommended by action)
      # Requires secrets: api_key (.p8 content), api_key_id, api_key_issuer_id
      # If unset, notarization falls back to APPLE_ID / APPLE_APP_SPECIFIC_PASSWORD / APPLE_TEAM_ID
      - name: Prepare for app notarization
        if: startsWith(matrix.os, 'macos')
        run: |
          if [ -n "${{ secrets.api_key }}" ]; then
            mkdir -p ~/private_keys/
            echo '${{ secrets.api_key }}' > ~/private_keys/AuthKey_${{ secrets.api_key_id }}.p8
          fi

      - name: Build/release Electron app
        uses: samuelmeuli/action-electron-builder@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          args: ${{ matrix.dist_args }}
          release: false
          # macOS code signing (secrets: MACOS_CERTIFICATE_BASE64, MACOS_CERTIFICATE_PASSWORD)
          mac_certs: ${{ secrets.MACOS_CERTIFICATE_BASE64 }}
          mac_certs_password: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: "false"
          # macOS notarization â€“ API key method (secrets: api_key, api_key_id, api_key_issuer_id)
          API_KEY_ID: ${{ secrets.api_key_id }}
          API_KEY_ISSUER_ID: ${{ secrets.api_key_issuer_id }}

      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/**
          if-no-files-found: error
          retention-days: 14
